# Storage URL Flow - Full PDF Upload

## Overview
This document describes how the `url` and `storageUrl` fields are populated in the search index for proper citation purposes.

## Storage Structure

### Blob Storage Containers (with prefix `myproject`)

1. **Citations Container** (`myproject-citations`)
   - **Full Documents**: `{base_filename}.pdf` (root level)
   - **Per-page PDFs**: `{base_filename}/page-0001.pdf`, `{base_filename}/page-0002.pdf`, etc.

2. **Pages Container** (`myproject-pages`)
   - Page metadata: `{base_filename}/page-0001.json`, etc.

3. **Chunks Container** (`myproject-chunks`)
   - Chunk data: `{base_filename}/page-0001/chunk-000001.json`, etc.

4. **Images Container** (`myproject-images`)
   - Images: `{base_filename}/page_01_fig_01.png`, `{base_filename}/page_02_fig_01.png`, etc.

## URL Fields in Search Index

### `url` Field (Original Full PDF Document)
- **Purpose**: Link to the complete original PDF document
- **Used for**: Providing users access to the full document

**Flow:**
1. **When input is BLOB**: Use the original blob URL directly
2. **When input is LOCAL and artifacts are BLOB**:
   - Upload full PDF to blob storage: `write_full_document()`
   - Store at: `{citations_container}/{base_filename}.pdf`
   - Cache URL in `self.full_document_urls[filename]`
   - Use this URL as `storage_url` in `DocumentMetadata`
3. **When input is LOCAL and artifacts are LOCAL**: Use file URI

### `storageUrl` Field (Per-Page PDF for Citations)
- **Purpose**: Direct link to the specific page PDF for citation
- **Used for**: Page-level citations that open directly to the specific page

**Flow:**
1. Per-page PDFs are generated by `split_and_store_page_pdfs()`
2. Stored at: `{citations_container}/{base_filename}/page-0001.pdf`
3. URLs cached in `self.page_pdf_urls[(filename, page_num)]`
4. Used as `page_blob_url` in `PageMetadata.create()`
5. In `ChunkDocument.to_search_document()`:
   - `storageUrl` = `page_blob_url` (if available) or `storage_url` (fallback)

## Example URLs

For document `sample_document.pdf`:

### Full Document URL (`url` field):
```
https://account.blob.core.windows.net/myproject-citations/sample_document.pdf
```

### Per-Page URLs (`storageUrl` field):
```
https://account.blob.core.windows.net/myproject-citations/sample_document/page-0001.pdf
https://account.blob.core.windows.net/myproject-citations/sample_document/page-0002.pdf
```

## Code Flow

### 1. Document Upload (pipeline.py:230-231)
```python
# Upload full document to blob if input is local and artifacts are blob
await self.upload_full_document(filename, file_bytes, source_url)
```

### 2. Full Document Upload (pipeline.py:549-572)
```python
async def upload_full_document(self, filename: str, pdf_bytes: bytes, source_url: str):
    if self.config.artifacts.mode == ArtifactsMode.BLOB:
        if not (source_url.startswith('http://') or source_url.startswith('https://')):
            full_doc_url = await self.artifact_storage.write_full_document(filename, pdf_bytes)
            self.full_document_urls[filename] = full_doc_url
```

### 3. Storage URL Assignment (pipeline.py:731-747)
```python
if self.config.artifacts.mode == ArtifactsMode.BLOB:
    if source_url.startswith('http://') or source_url.startswith('https://'):
        storage_url = source_url  # Use original blob URL
    else:
        storage_url = self.full_document_urls.get(filename)  # Use uploaded full document URL
else:
    storage_url = source_url  # Use file URI
```

### 4. Index Document Creation (models.py:234-238)
```python
"storageUrl": self.page.page_blob_url or self.document.storage_url,  # Per-page PDF for citations
"url": self.document.storage_url,  # Original full PDF document
```

## Benefits

1. **Proper Citations**: `storageUrl` points to the specific page, opening directly to that page
2. **Full Document Access**: `url` provides access to the complete original PDF
3. **Consistent Behavior**: Works the same whether input is local or blob
4. **No Broken Links**: Full PDFs are uploaded when needed, ensuring all URLs are valid
