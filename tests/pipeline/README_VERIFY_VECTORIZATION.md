# Verify Integrated Vectorization

This test script verifies that Azure Search integrated vectorization is working correctly.

## Purpose

When using integrated vectorization (`AZURE_USE_INTEGRATED_VECTORIZATION=true`), Azure Search generates embeddings automatically in the background. This means:
- Documents are uploaded WITHOUT embeddings in the stored field
- Azure Search generates embeddings using its configured vectorizer
- The `embeddings` field may appear empty when retrieving documents
- **But vector search WILL work** because Azure uses internal vectors

This script verifies that integrated vectorization is actually working by testing vector search functionality.

## Prerequisites

1. **Environment variables set** in your `.env` file:
   ```bash
   AZURE_SEARCH_SERVICE=your-search-service
   AZURE_SEARCH_INDEX=your-index-name
   AZURE_SEARCH_KEY=your-search-api-key
   AZURE_USE_INTEGRATED_VECTORIZATION=true
   ```

2. **Documents already uploaded** to your index using the pipeline

3. **Index configured with vectorizer** (should have been created with integrated vectorization enabled)

## How to Run

```bash
# From the project root
python test_pipeline/verify_vectorization.py
```

## What It Tests

### Test 1: Document Count
Verifies documents are indexed in Azure Search.

### Test 2: Stored Embeddings Field
Checks if the `embeddings` field contains data.
- **With integrated vectorization**: Field is empty `[]` - **THIS IS EXPECTED** ✓
- **With client-side embeddings**: Field contains full array

### Test 3: Vector Search (KEY TEST) ⭐
Performs a pure vector similarity search using `VectorizableTextQuery`.
- If this returns results → **Integrated vectorization IS WORKING** ✅
- If no results → Check index configuration or wait for embeddings to generate

### Test 4: Hybrid Search
Tests combined keyword + vector search.

## Expected Output

```
================================================================================
TEST 1: Checking if documents are indexed
================================================================================
✓ Found 150 documents in index

================================================================================
TEST 2: Checking stored embeddings field
================================================================================
  page_001_page1_chunk1: ✗ No stored embeddings (expected with integrated vectorization)
  page_002_page1_chunk1: ✗ No stored embeddings (expected with integrated vectorization)

Summary:
  Documents with stored embeddings: 0
  Documents without stored embeddings: 3

ℹ️  This is EXPECTED with integrated vectorization!
   Embeddings are generated by Azure Search and stored internally.

================================================================================
TEST 3: Testing vector search with integrated vectorization
================================================================================
Query: 'pacing therapies'

  Result 1: page_002_page1_chunk1
    Source: page_002.pdf#page=1
    Content: When Daily Trend is selected along with a fixed Amplitude...

✅ SUCCESS! Vector search returned 5 results
   This confirms integrated vectorization is WORKING correctly!
   Azure Search generated embeddings and used them for similarity search.

================================================================================
✅ VERIFICATION COMPLETE: Integrated vectorization is working!
================================================================================

Key Findings:
  • Documents are indexed in Azure Search
  • Stored embeddings field may be empty (expected)
  • Vector search queries return relevant results
  • Azure Search is generating embeddings in the background

Conclusion: Your integrated vectorization setup is correct! ✓
```

## Troubleshooting

### "Vector search returned 0 results"

**Possible causes:**
1. **Embeddings still being generated** - Azure Search generates embeddings asynchronously. Wait a few minutes and try again.
2. **Index vectorizer not configured** - Check your index definition has a vectorizer configured.
3. **Query doesn't match content** - Try a different query that matches your document content.

### "VectorizableTextQuery not supported"

**Cause:** Using an older Azure Search API version.

**Solution:** Update `azure-search-documents` package:
```bash
pip install --upgrade azure-search-documents
```

Ensure you're using API version `2024-07-01` or later.

### "Index doesn't have a vectorizer configured"

**Solution:** Your index needs to be created with a vectorizer. Check:
```python
# In index.py, ensure you have:
vectorizer = AzureOpenAIVectorizer(
    vectorizer_name="my-vectorizer",
    parameters=AzureOpenAIVectorizerParameters(
        resource_url=openai_endpoint,
        deployment_name=embedding_deployment,
        model_name="text-embedding-ada-002"
    )
)
```

## Understanding the Results

| Scenario | Stored Embeddings | Vector Search Works | Status |
|----------|------------------|-------------------|--------|
| **Integrated Vectorization** | Empty `[]` | ✅ Yes | ✅ **CORRECT** |
| Client-side Embeddings | Full array | ✅ Yes | ✅ Correct |
| **Broken Setup** | Empty `[]` | ❌ No results | ❌ Problem |

## Key Insight

The **critical test** is whether **vector search returns results**, not whether the stored `embeddings` field has data.

With integrated vectorization:
- ✅ Stored field empty = **EXPECTED**
- ✅ Vector search works = **PROOF IT'S WORKING**

## Alternative: Test in Azure Portal

You can also test in Azure Portal:
1. Go to your Search Service → Indexes → Your Index
2. Click **Search explorer**
3. Switch to **JSON view**
4. Test a vector query:
   ```json
   {
     "search": "*",
     "vectorQueries": [
       {
         "kind": "text",
         "text": "pacing therapies",
         "k": 5,
         "fields": "embeddings"
       }
     ]
   }
   ```
5. If you get results → Integrated vectorization is working! ✅

## See Also

- [Azure Search Integrated Vectorization Docs](https://learn.microsoft.com/azure/search/vector-search-integrated-vectorization)
- [test_embeddings_check.py](test_embeddings_check.py) - Check embeddings in indexed documents
- [../docs/EMBEDDING_MODES.md](../docs/EMBEDDING_MODES.md) - Documentation on embedding modes
